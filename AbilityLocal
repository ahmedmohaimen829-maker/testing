-- Optimized Hold Animation LocalScript
-- Place this in StarterPlayer > StarterCharacterScripts
--
-- OPTIMIZED: Preloaded animation, VFX, and audio for instant responsiveness

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")
local ContentProvider = game:GetService("ContentProvider")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Get RemoteEvent for server communication
local reFolder = ReplicatedStorage:WaitForChild("RE")
local slashAbilityEvent = reFolder:FindFirstChild("SlashAbilityEvent")
if not slashAbilityEvent then
	slashAbilityEvent = Instance.new("RemoteEvent")
	slashAbilityEvent.Name = "SlashAbilityEvent"
	slashAbilityEvent.Parent = reFolder
end

-- Configuration
local ANIMATION_ID = "125104321474109"

-- VFX Paths
local VFX_FOLDER = ReplicatedStorage:WaitForChild("VFX"):WaitForChild("Ability")
local STAB_VFX = VFX_FOLDER:WaitForChild("Stab")
local SLASH1_VFX = VFX_FOLDER:WaitForChild("Slash1")
local SLASH3_VFX = VFX_FOLDER:WaitForChild("Slash3")
local SLASH4_VFX = VFX_FOLDER:WaitForChild("Slash4")
local FINAL_VFX = VFX_FOLDER:WaitForChild("Final")

-- Audio ID Configuration
local STAB_AUDIO_ID = "101644004711755"
local SLASH1_AUDIO_ID = "101644004711755"
local SLASH3_AUDIO_ID = "101644004711755"
local SLASH4_AUDIO_ID = "101644004711755"
local FINAL_AUDIO_ID = "3359047385"

-- VFX Position Configuration
local STAB_POSITION = Vector3.new(1, 0, -3)
local SLASH1_POSITION = Vector3.new(0, 0, -0.1)
local SLASH3_POSITION = Vector3.new(0, 0, 0)
local SLASH4_POSITION = Vector3.new(0, 0, -3.5)
local FINAL_POSITION = Vector3.new(0, -3.5, -7)

-- VFX Rotation Configuration
local SLASH1_ROTATION = Vector3.new(0, 0, -127)
local SLASH3_ROTATION = Vector3.new(0, 0, 80)
local FINAL_ROTATION = Vector3.new(0, 0, 0)

-- VFX Cleanup Time
local VFX_CLEANUP_TIME = 3

-- State variables
local isPlaying = false
local originalWalkSpeed = humanoid.WalkSpeed
local originalJumpPower = humanoid.JumpPower
local alignPositionInstance = nil
local alignAttachment = nil
local lockAttachment = nil

-- OPTIMIZATION: Preloaded assets kept in memory
local preloadedAnimation = nil
local preloadedAnimationTrack = nil
local preloadedSounds = {}
local markerConnections = {}

-- OPTIMIZATION: VFX container pool for reuse
local vfxContainerPool = {}
local POOL_SIZE = 10

-- Function to get or create a VFX container from pool
local function getVFXContainer()
	for i, container in ipairs(vfxContainerPool) do
		if container and container.Parent == nil then
			container.Parent = workspace
			return container
		end
	end

	-- Create new container if pool is empty
	local container = Instance.new("Part")
	container.Name = "VFXContainer"
	container.Size = Vector3.new(1, 1, 1)
	container.Transparency = 1
	container.CanCollide = false
	container.Anchored = true
	container.Parent = workspace

	if #vfxContainerPool < POOL_SIZE then
		table.insert(vfxContainerPool, container)
	end

	return container
end

-- Function to return container to pool
local function returnVFXContainer(container)
	if container then
		-- Clear children
		for _, child in ipairs(container:GetChildren()) do
			child:Destroy()
		end
		container.Parent = nil
	end
end

-- Function to preload all assets (animation, VFX, audio)
local function preloadAllAssets()
	local assetsToPreload = {}

	-- Preload animation
	if ANIMATION_ID and ANIMATION_ID ~= "" then
		preloadedAnimation = Instance.new("Animation")
		preloadedAnimation.AnimationId = "rbxassetid://" .. ANIMATION_ID
		table.insert(assetsToPreload, preloadedAnimation)
	end

	-- Preload VFX templates
	table.insert(assetsToPreload, STAB_VFX)
	table.insert(assetsToPreload, SLASH1_VFX)
	table.insert(assetsToPreload, SLASH3_VFX)
	table.insert(assetsToPreload, SLASH4_VFX)
	table.insert(assetsToPreload, FINAL_VFX)

	-- Preload audio
	local audioIds = {
		Stab = STAB_AUDIO_ID,
		Slash1 = SLASH1_AUDIO_ID,
		Slash3 = SLASH3_AUDIO_ID,
		Slash4 = SLASH4_AUDIO_ID,
		Final = FINAL_AUDIO_ID
	}

	-- Clear existing sounds
	for _, sound in pairs(preloadedSounds) do
		if sound and sound.Parent then
			sound:Destroy()
		end
	end
	preloadedSounds = {}

	-- Create and store sounds
	for name, audioId in pairs(audioIds) do
		if audioId and audioId ~= "" then
			local sound = Instance.new("Sound")
			sound.SoundId = "rbxassetid://" .. audioId
			sound.Volume = 0.5
			sound.Parent = humanoidRootPart
			preloadedSounds[name] = sound
			table.insert(assetsToPreload, sound)
		end
	end

	-- Batch preload all assets
	if #assetsToPreload > 0 then
		ContentProvider:PreloadAsync(assetsToPreload)
	end

	-- OPTIMIZATION: Pre-load animation track (most important for first-press responsiveness)
	if preloadedAnimation and humanoid then
		-- Disconnect old connections
		for _, conn in ipairs(markerConnections) do
			conn:Disconnect()
		end
		markerConnections = {}

		preloadedAnimationTrack = humanoid:LoadAnimation(preloadedAnimation)

		-- Pre-connect marker signals (they persist across plays)
		table.insert(markerConnections, preloadedAnimationTrack:GetMarkerReachedSignal("Slash1"):Connect(function()
			playVFX("Stab")
			slashAbilityEvent:FireServer("Stab", character)
		end))

		table.insert(markerConnections, preloadedAnimationTrack:GetMarkerReachedSignal("Slash2"):Connect(function()
			playVFX("Slash1")
			slashAbilityEvent:FireServer("Slash1", character)
		end))

		table.insert(markerConnections, preloadedAnimationTrack:GetMarkerReachedSignal("Slash3"):Connect(function()
			playVFX("Slash3")
			slashAbilityEvent:FireServer("Slash3", character)
		end))

		table.insert(markerConnections, preloadedAnimationTrack:GetMarkerReachedSignal("Slash4"):Connect(function()
			playVFX("Slash4")
			slashAbilityEvent:FireServer("Slash4", character)
		end))

		table.insert(markerConnections, preloadedAnimationTrack:GetMarkerReachedSignal("Final"):Connect(function()
			playVFX("Final")
			slashAbilityEvent:FireServer("Final", character)
		end))
	end

	-- Pre-create VFX container pool
	for i = 1, POOL_SIZE do
		local container = Instance.new("Part")
		container.Name = "VFXContainer"
		container.Size = Vector3.new(1, 1, 1)
		container.Transparency = 1
		container.CanCollide = false
		container.Anchored = true
		container.Parent = nil -- Start in pool (not in workspace)
		table.insert(vfxContainerPool, container)
	end
end

-- Preload on script start
preloadAllAssets()

-- Function to lock movement completely
local function setMovementLocked(locked)
	if locked then
		originalWalkSpeed = humanoid.WalkSpeed
		originalJumpPower = humanoid.JumpPower

		humanoid.WalkSpeed = 0
		humanoid.JumpPower = 0

		local lockPosition = humanoidRootPart.Position

		lockAttachment = Instance.new("Attachment")
		lockAttachment.WorldPosition = lockPosition
		lockAttachment.Parent = workspace.Terrain or workspace

		alignAttachment = Instance.new("Attachment")
		alignAttachment.Name = "MovementLockAttachment"
		alignAttachment.Parent = humanoidRootPart

		alignPositionInstance = Instance.new("AlignPosition")
		alignPositionInstance.Name = "MovementLock"
		alignPositionInstance.Mode = Enum.PositionAlignmentMode.TwoAttachment
		alignPositionInstance.Attachment0 = alignAttachment
		alignPositionInstance.Attachment1 = lockAttachment
		alignPositionInstance.RigidityEnabled = true
		alignPositionInstance.MaxForce = math.huge
		alignPositionInstance.Responsiveness = 200
		alignPositionInstance.Parent = humanoidRootPart
	else
		if alignPositionInstance then
			alignPositionInstance:Destroy()
			alignPositionInstance = nil
		end

		if alignAttachment then
			alignAttachment:Destroy()
			alignAttachment = nil
		end

		if lockAttachment then
			lockAttachment:Destroy()
			lockAttachment = nil
		end

		humanoid.WalkSpeed = originalWalkSpeed
		humanoid.JumpPower = originalJumpPower
	end
end

-- OPTIMIZATION: Streamlined VFX playback
local function playVFXAtPosition(vfxTemplate, relativePosition, rotation, targetRootPart)
	targetRootPart = targetRootPart or humanoidRootPart
	if not vfxTemplate then return end

	local container = getVFXContainer()

	local rotationCFrame = CFrame.new()
	local useWorldRotation = false

	if rotation then
		if rotation.X == 0 and rotation.Y == 0 and rotation.Z == 0 then
			useWorldRotation = true
		else
			rotationCFrame = CFrame.Angles(
				math.rad(rotation.X),
				math.rad(rotation.Y),
				math.rad(rotation.Z)
			)
		end
	end

	local worldPosition = (targetRootPart.CFrame * CFrame.new(relativePosition)).Position

	if useWorldRotation then
		container.CFrame = CFrame.new(worldPosition)
	else
		container.CFrame = targetRootPart.CFrame * CFrame.new(relativePosition) * rotationCFrame
	end

	-- Process VFX (optimized - direct iteration)
	for _, child in ipairs(vfxTemplate:GetChildren()) do
		if child:IsA("Attachment") then
			local attachmentClone = child:Clone()
			attachmentClone.Parent = container

			for _, emitter in ipairs(attachmentClone:GetChildren()) do
				if emitter:IsA("ParticleEmitter") then
					emitter:Emit(emitter:GetAttribute("EmitCount") or 20)
				end
			end
		elseif child:IsA("BasePart") then
			local partClone = child:Clone()
			partClone.CFrame = container.CFrame * child.CFrame
			partClone.Anchored = true
			partClone.CanCollide = false
			partClone.Parent = container
		elseif child:IsA("ParticleEmitter") then
			local emitterClone = child:Clone()
			emitterClone.Parent = container
			emitterClone:Emit(emitterClone:GetAttribute("EmitCount") or 20)
		end
	end

	-- Schedule cleanup and return to pool
	task.delay(VFX_CLEANUP_TIME, function()
		returnVFXContainer(container)
	end)
end

-- OPTIMIZATION: Instant audio playback
local function playAudio(soundName, targetRootPart)
	targetRootPart = targetRootPart or humanoidRootPart

	local sound = preloadedSounds[soundName]
	if not sound then return end

	if targetRootPart ~= humanoidRootPart then
		-- Clone for other characters
		local soundClone = sound:Clone()
		soundClone.Parent = targetRootPart
		soundClone:Play()
		Debris:AddItem(soundClone, soundClone.TimeLength + 1)
	else
		-- Reuse for self - stop and restart for instant replay
		if sound.IsPlaying then
			sound:Stop()
		end
		sound:Play()
	end
end

-- VFX lookup table for cleaner code
local VFX_CONFIG = {
	Stab = {template = STAB_VFX, position = STAB_POSITION, rotation = nil},
	Slash1 = {template = SLASH1_VFX, position = SLASH1_POSITION, rotation = SLASH1_ROTATION},
	Slash3 = {template = SLASH3_VFX, position = SLASH3_POSITION, rotation = SLASH3_ROTATION},
	Slash4 = {template = SLASH4_VFX, position = SLASH4_POSITION, rotation = nil},
	Final = {template = FINAL_VFX, position = FINAL_POSITION, rotation = FINAL_ROTATION}
}

-- Unified VFX play function
local function playVFX(vfxType, targetRootPart)
	local config = VFX_CONFIG[vfxType]
	if config then
		playVFXAtPosition(config.template, config.position, config.rotation, targetRootPart)
		playAudio(vfxType, targetRootPart)
	end
end

-- Function to play VFX for a target character (for replication)
local function playVFXForCharacter(targetCharacter, vfxType)
	if not targetCharacter or not targetCharacter.Parent then return end

	local targetHumanoidRootPart = targetCharacter:FindFirstChild("HumanoidRootPart")
	if targetHumanoidRootPart then
		playVFX(vfxType, targetHumanoidRootPart)
	end
end

-- Listen for VFX replication from server
slashAbilityEvent.OnClientEvent:Connect(function(vfxType, targetCharacter)
	if vfxType and targetCharacter and targetCharacter ~= character then
		playVFXForCharacter(targetCharacter, vfxType)
	end
end)

-- OPTIMIZED: Animation playback using preloaded track
local function playAnimation()
	if isPlaying then return end

	if not preloadedAnimationTrack then
		warn("Animation not preloaded! Attempting to reload...")
		preloadAllAssets()
		if not preloadedAnimationTrack then
			warn("Failed to load animation. Check ANIMATION_ID.")
			return
		end
	end

	isPlaying = true
	setMovementLocked(true)

	-- Notify server that ability started
	slashAbilityEvent:FireServer("AbilityStart", character)

	-- Play the preloaded animation track (instant!)
	preloadedAnimationTrack:Play()

	-- Wait for animation to end
	preloadedAnimationTrack.Ended:Wait()

	-- Notify server that ability ended
	slashAbilityEvent:FireServer("AbilityEnd", character)

	setMovementLocked(false)
	isPlaying = false
end

-- Listen for R key press
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end

	if input.KeyCode == Enum.KeyCode.R then
		playAnimation()
	end
end)

-- Handle character respawn
player.CharacterAdded:Connect(function(newCharacter)
	character = newCharacter
	humanoid = newCharacter:WaitForChild("Humanoid")
	humanoidRootPart = newCharacter:WaitForChild("HumanoidRootPart")
	originalWalkSpeed = humanoid.WalkSpeed
	originalJumpPower = humanoid.JumpPower
	isPlaying = false

	setMovementLocked(false)

	-- Reload all assets for new character
	preloadAllAssets()
end)
