-- Hold Animation LocalScript
-- Place this in StarterPlayer > StarterCharacterScripts
-- 
-- This script plays an animation when R is pressed
-- During the animation, movement is completely locked
-- VFX plays when animation events fire

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")
local ContentProvider = game:GetService("ContentProvider")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Get RemoteEvent for server communication
local reFolder = ReplicatedStorage:WaitForChild("RE")
local slashAbilityEvent = reFolder:FindFirstChild("SlashAbilityEvent")
if not slashAbilityEvent then
	slashAbilityEvent = Instance.new("RemoteEvent")
	slashAbilityEvent.Name = "SlashAbilityEvent"
	slashAbilityEvent.Parent = reFolder
end

-- Configuration
local ANIMATION_ID = "125104321474109"

-- VFX Paths
local VFX_FOLDER = ReplicatedStorage:WaitForChild("VFX"):WaitForChild("Ability")
local STAB_VFX = VFX_FOLDER:WaitForChild("Stab")
local SLASH1_VFX = VFX_FOLDER:WaitForChild("Slash1")
local SLASH3_VFX = VFX_FOLDER:WaitForChild("Slash3")
local SLASH4_VFX = VFX_FOLDER:WaitForChild("Slash4")
local FINAL_VFX = VFX_FOLDER:WaitForChild("Final")

-- Audio ID Configuration
local STAB_AUDIO_ID = "101644004711755"
local SLASH1_AUDIO_ID = "101644004711755"
local SLASH3_AUDIO_ID = "101644004711755"
local SLASH4_AUDIO_ID = "101644004711755"
local FINAL_AUDIO_ID = "3359047385"

-- VFX Position Configuration
local STAB_POSITION = Vector3.new(1, 0, -3)
local SLASH1_POSITION = Vector3.new(0, 0, -0.1)
local SLASH3_POSITION = Vector3.new(0, 0, -0)
local SLASH4_POSITION = Vector3.new(0, 0, -3.5)
local FINAL_POSITION = Vector3.new(0, -3.5, -7)

-- VFX Rotation Configuration
local SLASH1_ROTATION = Vector3.new(0, 0, -127)
local SLASH3_ROTATION = Vector3.new(0, 0, 80)
local FINAL_ROTATION = Vector3.new(0, 0, 0)

-- VFX Cleanup Time
local VFX_CLEANUP_TIME = 3

-- State variables
local animationTrack = nil
local isPlaying = false
local originalWalkSpeed = humanoid.WalkSpeed
local originalJumpPower = humanoid.JumpPower
local alignPositionInstance = nil
local alignAttachment = nil
local lockAttachment = nil
local activeVFXParts = {}

-- Preloaded audio sounds (kept in memory, ready to play instantly)
local preloadedSounds = {}

-- Function to preload all audio
local function preloadAudio()
	-- Clear any existing preloaded sounds
	for _, sound in pairs(preloadedSounds) do
		if sound and sound.Parent then
			sound:Destroy()
		end
	end
	preloadedSounds = {}

	local audioIds = {
		Stab = STAB_AUDIO_ID,
		Slash1 = SLASH1_AUDIO_ID,
		Slash3 = SLASH3_AUDIO_ID,
		Slash4 = SLASH4_AUDIO_ID,
		Final = FINAL_AUDIO_ID
	}

	-- Create and preload each sound
	for name, audioId in pairs(audioIds) do
		if audioId and audioId ~= "" then
			local sound = Instance.new("Sound")
			sound.SoundId = "rbxassetid://" .. audioId
			sound.Volume = 0.5
			sound.Parent = humanoidRootPart

			-- Store reference
			preloadedSounds[name] = sound
		end
	end

	-- Preload all sounds using ContentProvider
	local soundsToPreload = {}
	for _, sound in pairs(preloadedSounds) do
		table.insert(soundsToPreload, sound.SoundId)
	end

	if #soundsToPreload > 0 then
		-- This ensures sounds are loaded into memory
		ContentProvider:PreloadAsync(soundsToPreload)
	end
end

-- Preload audio on script start
preloadAudio()

-- Function to clean up all active VFX parts
local function cleanupAllVFX()
	for _, part in ipairs(activeVFXParts) do
		if part and part.Parent then
			part:Destroy()
		end
	end
	activeVFXParts = {}
end

-- Function to lock movement completely
local function setMovementLocked(locked)
	if locked then
		originalWalkSpeed = humanoid.WalkSpeed
		originalJumpPower = humanoid.JumpPower

		humanoid.WalkSpeed = 0
		humanoid.JumpPower = 0

		local lockPosition = humanoidRootPart.Position

		lockAttachment = Instance.new("Attachment")
		lockAttachment.WorldPosition = lockPosition
		lockAttachment.Parent = workspace.Terrain or workspace

		alignAttachment = Instance.new("Attachment")
		alignAttachment.Name = "MovementLockAttachment"
		alignAttachment.Parent = humanoidRootPart

		alignPositionInstance = Instance.new("AlignPosition")
		alignPositionInstance.Name = "MovementLock"
		alignPositionInstance.Mode = Enum.PositionAlignmentMode.TwoAttachment
		alignPositionInstance.Attachment0 = alignAttachment
		alignPositionInstance.Attachment1 = lockAttachment
		alignPositionInstance.RigidityEnabled = true
		alignPositionInstance.MaxForce = math.huge
		alignPositionInstance.Responsiveness = 200
		alignPositionInstance.Parent = humanoidRootPart
	else
		if alignPositionInstance then
			alignPositionInstance:Destroy()
			alignPositionInstance = nil
		end

		if alignAttachment then
			alignAttachment:Destroy()
			alignAttachment = nil
		end

		if lockAttachment then
			lockAttachment:Destroy()
			lockAttachment = nil
		end

		humanoid.WalkSpeed = originalWalkSpeed
		humanoid.JumpPower = originalJumpPower
	end
end

-- Function to play VFX at a position relative to HumanoidRootPart
local function playVFXAtPosition(vfxTemplate, relativePosition, rotation, targetRootPart)
	targetRootPart = targetRootPart or humanoidRootPart
	if not vfxTemplate then 
		warn("VFX template not found!")
		return 
	end

	local vfxClone = vfxTemplate:Clone()

	local rotationCFrame = CFrame.new(0, 0, 0)
	local useWorldRotation = false
	if rotation then
		if rotation.X == 0 and rotation.Y == 0 and rotation.Z == 0 then
			useWorldRotation = true
			rotationCFrame = CFrame.Angles(0, 0, 0)
		else
			rotationCFrame = CFrame.Angles(
				math.rad(rotation.X),
				math.rad(rotation.Y),
				math.rad(rotation.Z)
			)
		end
	end

	local container = Instance.new("Part")
	container.Name = "VFXContainer"
	container.Size = Vector3.new(1, 1, 1)
	container.Transparency = 1
	container.CanCollide = false
	container.Anchored = true

	local worldPosition = (targetRootPart.CFrame * CFrame.new(relativePosition)).Position

	if useWorldRotation then
		container.CFrame = CFrame.new(worldPosition)
	else
		container.CFrame = targetRootPart.CFrame * CFrame.new(relativePosition) * rotationCFrame
	end
	container.Parent = workspace

	table.insert(activeVFXParts, container)

	local function processVFX(obj, parent)
		for _, child in ipairs(obj:GetChildren()) do
			if child:IsA("Attachment") then
				local attachmentClone = child:Clone()
				attachmentClone.Parent = container

				for _, emitter in ipairs(attachmentClone:GetChildren()) do
					if emitter:IsA("ParticleEmitter") then
						local emitCount = emitter:GetAttribute("EmitCount") or 20
						emitter:Emit(emitCount)
					end
				end
			elseif child:IsA("BasePart") then
				local partClone = child:Clone()
				partClone.CFrame = container.CFrame * child.CFrame
				partClone.Anchored = true
				partClone.CanCollide = false
				partClone.Parent = container

				table.insert(activeVFXParts, partClone)

				processVFX(child, partClone)
			elseif child:IsA("ParticleEmitter") then
				local emitterClone = child:Clone()
				emitterClone.Parent = container

				local emitCount = emitterClone:GetAttribute("EmitCount") or 20
				emitterClone:Emit(emitCount)
			else
				processVFX(child, parent)
			end
		end
	end

	processVFX(vfxClone, container)

	vfxClone:Destroy()

	Debris:AddItem(container, VFX_CLEANUP_TIME)
end

-- Function to play preloaded audio instantly
local function playAudio(soundName, targetRootPart)
	targetRootPart = targetRootPart or humanoidRootPart

	local sound = preloadedSounds[soundName]
	if sound then
		-- Clone the sound for other characters, or use original for self
		local soundToPlay = sound
		if targetRootPart ~= humanoidRootPart then
			soundToPlay = sound:Clone()
			soundToPlay.Parent = targetRootPart
		else
			-- Stop if already playing to allow immediate replay
			if sound.IsPlaying then
				sound:Stop()
			end
		end
		soundToPlay:Play()

		-- Clean up cloned sounds
		if soundToPlay ~= sound then
			soundToPlay.Ended:Connect(function()
				soundToPlay:Destroy()
			end)
			Debris:AddItem(soundToPlay, 10)
		end
	end
end

-- Function to play VFX for a target character (for replication)
local function playVFXForCharacter(targetCharacter, vfxType)
	if not targetCharacter or not targetCharacter.Parent then return end

	local targetHumanoidRootPart = targetCharacter:FindFirstChild("HumanoidRootPart")
	if not targetHumanoidRootPart then return end

	-- Play the appropriate VFX at the target character's position
	if vfxType == "Stab" then
		playVFXAtPosition(STAB_VFX, STAB_POSITION, nil, targetHumanoidRootPart)
		playAudio("Stab", targetHumanoidRootPart)
	elseif vfxType == "Slash1" then
		playVFXAtPosition(SLASH1_VFX, SLASH1_POSITION, SLASH1_ROTATION, targetHumanoidRootPart)
		playAudio("Slash1", targetHumanoidRootPart)
	elseif vfxType == "Slash3" then
		playVFXAtPosition(SLASH3_VFX, SLASH3_POSITION, SLASH3_ROTATION, targetHumanoidRootPart)
		playAudio("Slash3", targetHumanoidRootPart)
	elseif vfxType == "Slash4" then
		playVFXAtPosition(SLASH4_VFX, SLASH4_POSITION, nil, targetHumanoidRootPart)
		playAudio("Slash4", targetHumanoidRootPart)
	elseif vfxType == "Final" then
		playVFXAtPosition(FINAL_VFX, FINAL_POSITION, FINAL_ROTATION, targetHumanoidRootPart)
		playAudio("Final", targetHumanoidRootPart)
	end
end

-- Listen for VFX replication from server
slashAbilityEvent.OnClientEvent:Connect(function(vfxType, targetCharacter)
	if vfxType and targetCharacter then
		-- Don't play for our own character (we already played it locally)
		if targetCharacter ~= character then
			playVFXForCharacter(targetCharacter, vfxType)
		end
	end
end)

-- VFX functions with audio
local function playSlash1VFX()
	playVFXAtPosition(SLASH1_VFX, SLASH1_POSITION, SLASH1_ROTATION)
	playAudio("Slash1")
end

local function playSlash3VFX()
	playVFXAtPosition(SLASH3_VFX, SLASH3_POSITION, SLASH3_ROTATION)
	playAudio("Slash3")
end

local function playSlash4VFX()
	playVFXAtPosition(SLASH4_VFX, SLASH4_POSITION)
	playAudio("Slash4")
end

local function playFinalVFX()
	playVFXAtPosition(FINAL_VFX, FINAL_POSITION, FINAL_ROTATION)
	playAudio("Final")
end

local function playStabVFX()
	playVFXAtPosition(STAB_VFX, STAB_POSITION)
	playAudio("Stab")
end

-- Function to play animation
local function playAnimation()
	if isPlaying then
		return
	end

	if ANIMATION_ID == "" then
		warn("ANIMATION_ID is not set! Please set your animation ID in the script.")
		return
	end

	isPlaying = true

	cleanupAllVFX()

	setMovementLocked(true)

	-- Notify server that ability started
	slashAbilityEvent:FireServer("AbilityStart", character)

	local animation = Instance.new("Animation")
	animation.AnimationId = "rbxassetid://" .. ANIMATION_ID
	animationTrack = humanoid:LoadAnimation(animation)

	animationTrack:GetMarkerReachedSignal("Slash1"):Connect(function()
		playStabVFX()
		-- Notify server to replicate to all clients
		slashAbilityEvent:FireServer("Stab", character)
	end)

	animationTrack:GetMarkerReachedSignal("Slash2"):Connect(function()
		playSlash1VFX()
		slashAbilityEvent:FireServer("Slash1", character)
	end)

	animationTrack:GetMarkerReachedSignal("Slash3"):Connect(function()
		playSlash3VFX()
		slashAbilityEvent:FireServer("Slash3", character)
	end)

	animationTrack:GetMarkerReachedSignal("Slash4"):Connect(function()
		playSlash4VFX()
		slashAbilityEvent:FireServer("Slash4", character)
	end)

	animationTrack:GetMarkerReachedSignal("Final"):Connect(function()
		playFinalVFX()
		slashAbilityEvent:FireServer("Final", character)
	end)

	animationTrack:Play()

	animationTrack.Ended:Wait()

	-- Notify server that ability ended (unlocks all hit players)
	slashAbilityEvent:FireServer("AbilityEnd", character)

	setMovementLocked(false)

	if animationTrack then
		animationTrack:Stop()
		animationTrack:Destroy()
		animationTrack = nil
	end

	isPlaying = false
end

-- Listen for R key press
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end

	if input.KeyCode == Enum.KeyCode.R then
		playAnimation()
	end
end)

-- Handle character respawn
player.CharacterAdded:Connect(function(newCharacter)
	character = newCharacter
	humanoid = newCharacter:WaitForChild("Humanoid")
	humanoidRootPart = newCharacter:WaitForChild("HumanoidRootPart")
	originalWalkSpeed = humanoid.WalkSpeed
	originalJumpPower = humanoid.JumpPower
	isPlaying = false

	cleanupAllVFX()

	if animationTrack then
		animationTrack:Stop()
		animationTrack:Destroy()
		animationTrack = nil
	end

	setMovementLocked(false)

	-- Repreload audio for new character
	preloadAudio()
end)
